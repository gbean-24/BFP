<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rUok - Travel Safety Tracker</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <!-- Loading Screen -->
        <div id="loading" class="loading-screen">
            <div class="loading-spinner"></div>
            <p>Loading rUok...</p>
        </div>

        <!-- Authentication Pages -->
        <div id="auth-container" class="auth-container hidden">
            <!-- Login Page -->
            <div id="login-page" class="auth-page">
                <div class="auth-card">
                    <h1>üõ°Ô∏è rUok</h1>
                    <p>Stay safe while traveling</p>
                    
                    <form id="login-form">
                        <div class="form-group">
                            <label for="login-email">Email</label>
                            <input type="email" id="login-email" required>
                        </div>
                        <div class="form-group">
                            <label for="login-password">Password</label>
                            <input type="password" id="login-password" required>
                        </div>
                        <button type="submit" class="btn-primary">Login</button>
                        <div class="auth-switch">
                            <p>Don't have an account? <a href="#" id="show-register">Register</a></p>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Register Page -->
            <div id="register-page" class="auth-page hidden">
                <div class="auth-card">
                    <h1>üõ°Ô∏è Join rUok</h1>
                    <p>Create your safety account</p>
                    
                    <form id="register-form">
                        <div class="form-group">
                            <label for="register-name">Full Name</label>
                            <input type="text" id="register-name" required>
                        </div>
                        <div class="form-group">
                            <label for="register-email">Email</label>
                            <input type="email" id="register-email" required>
                        </div>
                        <div class="form-group">
                            <label for="register-password">Password</label>
                            <input type="password" id="register-password" required>
                        </div>
                        <div class="form-group">
                            <label for="register-phone">Phone (Optional)</label>
                            <input type="tel" id="register-phone">
                        </div>
                        <button type="submit" class="btn-primary">Create Account</button>
                        <div class="auth-switch">
                            <p>Already have an account? <a href="#" id="show-login">Login</a></p>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="main-app" class="main-app hidden">
            <nav class="navbar">
                <div class="nav-brand">
                    <h2>üõ°Ô∏è rUok</h2>
                </div>
                <div class="nav-menu">
                    <button id="nav-dashboard" class="nav-btn active">Dashboard</button>
                    <button id="nav-trips" class="nav-btn">My Trips</button>
                    <button id="logout-btn" class="nav-btn logout">Logout</button>
                </div>
            </nav>
            
            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page" style="padding: 30px;">
                <div class="page-header">
                    <h1>Dashboard</h1>
                    <button id="emergency-btn" class="btn-emergency">üö® Emergency Alert</button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <!-- Current Trip -->
                    <div class="card" style="background: white; padding: 20px; border-radius: 12px;">
                        <h3>Current Trip</h3>
                        <div id="current-trip-info">
                            <p>No active trip</p>
                            <button id="create-first-trip" class="btn-primary">Create Your First Trip</button>
                        </div>
                    </div>

                    <!-- Location Status -->
                    <div class="card" style="background: white; padding: 20px; border-radius: 12px;">
                        <h3>Location Status</h3>
                        <div id="location-status">
                            <p>Location tracking: <span class="status-indicator status-inactive"></span><span id="location-status-text" style="color: #dc2626;">Off</span></p>
                            <button id="toggle-location" class="btn-primary">Enable Tracking</button>
                        </div>
                    </div>

                    <!-- Backend Test -->
                    <div class="card" style="background: white; padding: 20px; border-radius: 12px;">
                        <h3>Backend Connection</h3>
                        <button id="test-backend" class="btn-secondary">Test Connection</button>
                        <div id="test-result" style="margin-top: 15px;"></div>
                    </div>
                </div>
            </div>

            <!-- Trips Page -->
            <div id="trips-page" class="page hidden" style="padding: 30px;">
                <div class="page-header">
                    <h1>My Trips</h1>
                    <button id="new-trip-btn" class="btn-primary">Create New Trip</button>
                </div>
                
                <div id="trips-list">
                    <!-- Trips will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Trip Creation Modal -->
        <div id="trip-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Create New Trip</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <form id="trip-form">
                    <div class="form-group">
                        <label for="trip-name">Trip Name</label>
                        <input type="text" id="trip-name" required placeholder="e.g., Paris Weekend">
                    </div>
                    <div class="form-group">
                        <label for="trip-description">Description</label>
                        <textarea id="trip-description" placeholder="Describe your trip..."></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="trip-start">Start Date</label>
                            <input type="datetime-local" id="trip-start" required>
                        </div>
                        <div class="form-group">
                            <label for="trip-end">End Date</label>
                            <input type="datetime-local" id="trip-end" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="deviation-threshold">Safety Radius (km)</label>
                        <input type="number" id="deviation-threshold" value="2" min="0.5" max="10" step="0.5">
                        <small>Alert when more than this distance from planned locations</small>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary modal-cancel">Cancel</button>
                        <button type="submit" class="btn-primary">Create Trip</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Location Modal -->
        <div id="location-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add Planned Location</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <form id="location-form">
                    <div class="form-group">
                        <label for="location-search">Search Location</label>
                        <input type="text" id="location-search" required placeholder="e.g., Eiffel Tower, Paris" autocomplete="off">
                        <div id="search-results" class="search-results hidden"></div>
                        <small>Type a landmark, address, or place name</small>
                        <div class="popular-locations">
                            <small style="color: #6b7280;">Popular: </small>
                            <button type="button" class="location-suggestion" onclick="quickSearch('Eiffel Tower, Paris')">Eiffel Tower</button>
                            <button type="button" class="location-suggestion" onclick="quickSearch('Times Square, New York')">Times Square</button>
                            <button type="button" class="location-suggestion" onclick="quickSearch('Big Ben, London')">Big Ben</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="location-name">Selected Location</label>
                        <input type="text" id="location-name" readonly placeholder="Location will appear here after search">
                    </div>
                    <div class="form-group">
                        <label for="location-description">Description</label>
                        <textarea id="location-description" placeholder="What will you do here?"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="location-lat">Latitude</label>
                            <input type="number" id="location-lat" step="any" readonly placeholder="Auto-filled">
                        </div>
                        <div class="form-group">
                            <label for="location-lng">Longitude</label>
                            <input type="number" id="location-lng" step="any" readonly placeholder="Auto-filled">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="location-arrival">Planned Arrival (Optional)</label>
                        <input type="datetime-local" id="location-arrival">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="location-accommodation">
                            This is accommodation (hotel, etc.)
                        </label>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary modal-cancel">Cancel</button>
                        <button type="submit" class="btn-primary">Add Location</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Emergency Modal -->
        <div id="emergency-modal" class="modal hidden">
            <div class="modal-content">
                <div class="emergency-header" style="text-align: center; margin-bottom: 20px;">
                    <h2 style="color: #dc2626;">üö® Emergency Alert</h2>
                    <p>This will send an immediate alert</p>
                </div>
                <form id="emergency-form">
                    <div class="form-group">
                        <label for="emergency-message">What's happening?</label>
                        <textarea id="emergency-message" placeholder="Describe your emergency..." required></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary modal-cancel">Cancel</button>
                        <button type="submit" class="btn-emergency">Send Emergency Alert</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Floating Action Button -->
        <button id="fab-add-location" class="fab hidden" onclick="showLocationModal()" title="Add Location">
            üìç
        </button>

        <!-- Notifications -->
        <div id="notifications" class="notifications"></div>
    </div>

    <!-- Simple API Client -->
    <script>
        const API_BASE_URL = 'http://localhost:8000/api/secure';
        let authToken = localStorage.getItem('auth_token');

        // Simple notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<p>${message}</p>`;
            document.getElementById('notifications').appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        // Simple API calls
        async function apiCall(endpoint, data = null, method = 'GET') {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (authToken) {
                options.headers['Authorization'] = `Bearer ${authToken}`;
            }

            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.detail || 'API Error');
                }
                
                return result;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        let currentTrip = null;
        let locationTracking = false;

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Hide loading after 1 second
            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
                
                if (authToken) {
                    showMainApp();
                } else {
                    showAuth();
                }
            }, 1000);

            // Auth form handlers
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('show-register').addEventListener('click', showRegister);
            document.getElementById('show-login').addEventListener('click', showLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('test-backend').addEventListener('click', testBackend);

            // Navigation handlers
            document.getElementById('nav-dashboard').addEventListener('click', () => showPage('dashboard'));
            document.getElementById('nav-trips').addEventListener('click', () => showPage('trips'));

            // Trip handlers
            document.getElementById('create-first-trip').addEventListener('click', showTripModal);
            document.getElementById('new-trip-btn').addEventListener('click', showTripModal);
            document.getElementById('trip-form').addEventListener('submit', handleCreateTrip);
            document.getElementById('location-form').addEventListener('submit', handleAddLocation);
            document.getElementById('emergency-form').addEventListener('submit', handleEmergencyAlert);

            // Location tracking
            document.getElementById('toggle-location').addEventListener('click', toggleLocationTracking);
            document.getElementById('emergency-btn').addEventListener('click', showEmergencyModal);

            // Location search
            setupLocationSearch();

            // Modal handlers
            setupModalHandlers();
        });

        function showAuth() {
            document.getElementById('auth-container').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
        }

        function showRegister(e) {
            e.preventDefault();
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('register-page').classList.remove('hidden');
        }

        function showLogin(e) {
            e.preventDefault();
            document.getElementById('register-page').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden');
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            const userData = {
                name: document.getElementById('register-name').value,
                email: document.getElementById('register-email').value,
                password: document.getElementById('register-password').value,
                phone: document.getElementById('register-phone').value || null
            };

            try {
                await apiCall('/auth/register', userData, 'POST');
                showNotification('Registration successful! Please login.', 'success');
                showLogin(e);
            } catch (error) {
                showNotification(`Registration failed: ${error.message}`, 'error');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const credentials = {
                email: document.getElementById('login-email').value,
                password: document.getElementById('login-password').value
            };

            try {
                console.log('Attempting login with:', credentials.email);
                const response = await apiCall('/auth/login', credentials, 'POST');
                authToken = response.access_token;
                localStorage.setItem('auth_token', authToken);
                
                showNotification('Login successful!', 'success');
                showMainApp();
                loadDashboard();
            } catch (error) {
                console.error('Login error:', error);
                showNotification(`Login failed: ${error.message}. Try registering a new account.`, 'error');
            }
        }

        function handleLogout() {
            authToken = null;
            localStorage.removeItem('auth_token');
            showNotification('Logged out successfully', 'success');
            showAuth();
        }

        async function testBackend() {
            try {
                const response = await fetch('http://localhost:8000/health');
                const result = await response.json();
                document.getElementById('test-result').innerHTML = `
                    <p style="color: green;">‚úÖ Backend Connected!</p>
                    <p>Status: ${result.status}</p>
                `;
            } catch (error) {
                document.getElementById('test-result').innerHTML = `
                    <p style="color: red;">‚ùå Backend Connection Failed</p>
                    <p>Make sure backend is running on localhost:8000</p>
                `;
            }
        }

        // Page navigation
        function showPage(pageName) {
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`nav-${pageName}`).classList.add('active');

            // Hide all pages
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            
            // Show selected page
            document.getElementById(`${pageName}-page`).classList.remove('hidden');

            // Load page data
            if (pageName === 'dashboard') {
                loadDashboard();
            } else if (pageName === 'trips') {
                loadTrips();
            }
        }

        async function loadDashboard() {
            try {
                const trips = await apiCall('/trips');
                const activeTrip = trips.find(trip => trip.is_active);
                
                if (activeTrip) {
                    currentTrip = activeTrip;
                    document.getElementById('current-trip-info').innerHTML = `
                        <div>
                            <h4>${activeTrip.name}</h4>
                            <p>${activeTrip.description || 'No description'}</p>
                            <p><strong>Safety Radius:</strong> ${activeTrip.deviation_threshold_km}km</p>
                            <button class="btn-secondary" onclick="viewTrip(${activeTrip.id})">View Details</button>
                            <button class="btn-primary" onclick="showLocationModal()" style="margin-left: 10px;">üìç Add Location</button>
                        </div>
                    `;
                    // Show floating action button
                    document.getElementById('fab-add-location').classList.remove('hidden');
                } else {
                    document.getElementById('current-trip-info').innerHTML = `
                        <p>No active trip</p>
                        <button id="create-first-trip" class="btn-primary" onclick="showTripModal()">Create Your First Trip</button>
                    `;
                    // Hide floating action button
                    document.getElementById('fab-add-location').classList.add('hidden');
                }
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        async function loadTrips() {
            try {
                const trips = await apiCall('/trips');
                const container = document.getElementById('trips-list');
                
                if (trips.length === 0) {
                    container.innerHTML = `
                        <div class="card" style="background: white; padding: 20px; border-radius: 12px;">
                            <p>No trips created yet</p>
                            <button class="btn-primary" onclick="showTripModal()">Create Your First Trip</button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = trips.map(trip => {
                    const startDate = new Date(trip.start_date);
                    const endDate = new Date(trip.end_date);
                    const now = new Date();
                    
                    let status = 'upcoming';
                    if (now >= startDate && now <= endDate) status = 'active';
                    else if (now > endDate) status = 'completed';

                    return `
                        <div class="card" style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; cursor: pointer;" onclick="viewTrip(${trip.id})">
                            <h3>${trip.name}</h3>
                            <p>${trip.description || 'No description'}</p>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                                <span>${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}</span>
                                <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; background: ${status === 'active' ? '#dcfce7; color: #166534' : status === 'upcoming' ? '#dbeafe; color: #1e40af' : '#f3f4f6; color: #6b7280'}">${status}</span>
                            </div>
                            <p style="margin-top: 10px; color: #6b7280;"><strong>Safety Radius:</strong> ${trip.deviation_threshold_km}km</p>
                            <div style="margin-top: 10px; display: flex; gap: 10px;">
                                <button class="btn-primary" onclick="selectTripAndAddLocation(${trip.id})">üìç Add Location</button>
                                <button class="btn-secondary" onclick="shareTrip(${trip.id})">üì§ Share Trip</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load trips:', error);
                showNotification('Failed to load trips', 'error');
            }
        }

        function showTripModal() {
            document.getElementById('trip-modal').classList.remove('hidden');
            
            // Set default dates
            const now = new Date();
            const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
            const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('trip-start').value = tomorrow.toISOString().slice(0, 16);
            document.getElementById('trip-end').value = nextWeek.toISOString().slice(0, 16);
        }

        async function handleCreateTrip(e) {
            e.preventDefault();
            
            try {
                const tripData = {
                    name: document.getElementById('trip-name').value,
                    description: document.getElementById('trip-description').value,
                    start_date: document.getElementById('trip-start').value,
                    end_date: document.getElementById('trip-end').value,
                    deviation_threshold_km: parseFloat(document.getElementById('deviation-threshold').value),
                    monitoring_enabled: true
                };

                const trip = await apiCall('/trips', tripData, 'POST');
                showNotification('Trip created successfully!', 'success');
                closeModals();
                
                // Set as current trip and show location modal
                currentTrip = trip;
                showNotification('Now add your planned locations!', 'info');
                setTimeout(() => showLocationModal(), 1000);
                
                loadDashboard();
                
            } catch (error) {
                console.error('Failed to create trip:', error);
                showNotification(`Failed to create trip: ${error.message}`, 'error');
            }
        }

        function showLocationModal() {
            if (!currentTrip) {
                showNotification('Please create a trip first', 'error');
                return;
            }
            document.getElementById('location-modal').classList.remove('hidden');
        }

        async function handleAddLocation(e) {
            e.preventDefault();
            
            if (!currentTrip) {
                showNotification('No trip selected', 'error');
                return;
            }

            try {
                const locationData = {
                    name: document.getElementById('location-name').value,
                    description: document.getElementById('location-description').value,
                    latitude: parseFloat(document.getElementById('location-lat').value),
                    longitude: parseFloat(document.getElementById('location-lng').value),
                    planned_arrival: document.getElementById('location-arrival').value || null,
                    is_accommodation: document.getElementById('location-accommodation').checked
                };

                await apiCall(`/trips/${currentTrip.id}/planned-locations`, locationData, 'POST');
                showNotification('Location added successfully!', 'success');
                closeModals();
                
                // Ask if they want to add more locations
                setTimeout(() => {
                    if (confirm('Location added! Would you like to add another location?')) {
                        showLocationModal();
                    } else {
                        showNotification('Great! Now you can test location tracking.', 'info');
                    }
                }, 500);
                
            } catch (error) {
                console.error('Failed to add location:', error);
                showNotification(`Failed to add location: ${error.message}`, 'error');
            }
        }

        async function viewTrip(tripId) {
            try {
                const trip = await apiCall(`/trips/${tripId}`);
                currentTrip = trip;
                showNotification(`Viewing trip: ${trip.name}`, 'info');
                
                // Show option to add locations
                setTimeout(() => {
                    if (confirm('Would you like to add planned locations to this trip?')) {
                        showLocationModal();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Failed to load trip:', error);
                showNotification('Failed to load trip details', 'error');
            }
        }

        async function toggleLocationTracking() {
            if (!currentTrip) {
                showNotification('Please create a trip first to enable location tracking', 'warning');
                return;
            }

            if (locationTracking) {
                locationTracking = false;
                document.getElementById('location-status-text').textContent = 'Off';
                document.getElementById('location-status-text').style.color = '#dc2626';
                document.getElementById('toggle-location').textContent = 'Enable Tracking';
                showNotification('Location tracking disabled', 'info');
            } else {
                try {
                    // Test location access
                    await getCurrentLocation();
                    locationTracking = true;
                    document.getElementById('location-status-text').textContent = 'On';
                    document.getElementById('location-status-text').style.color = '#059669';
                    document.getElementById('toggle-location').textContent = 'Disable Tracking';
                    document.querySelector('.status-indicator').className = 'status-indicator status-active';
                    showNotification('Location tracking enabled! Testing geofencing...', 'success');
                    
                    // Submit a test location
                    setTimeout(() => testGeofencing(), 2000);
                    
                } catch (error) {
                    showNotification(`Location access failed: ${error.message}`, 'error');
                }
            }
        }

        async function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        });
                    },
                    (error) => reject(new Error(`Location error: ${error.message}`)),
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            });
        }

        async function testGeofencing() {
            if (!currentTrip) return;

            try {
                // Submit a location far from planned locations to test geofencing
                const testLocation = {
                    trip_id: currentTrip.id,
                    latitude: 49.0000,  // Far from most planned locations
                    longitude: 3.0000,
                    accuracy_meters: 10,
                    timestamp: new Date().toISOString(),
                    battery_level: 85,
                    is_manual: true
                };

                const response = await apiCall('/location-updates', testLocation, 'POST');
                
                if (response.alerts_triggered && response.alerts_triggered.length > 0) {
                    showNotification(`üö® GEOFENCING WORKS! ${response.message}`, 'warning');
                    setTimeout(() => {
                        showNotification('Check your alerts! The safety system detected you are far from planned locations.', 'info');
                    }, 2000);
                } else {
                    showNotification('Location submitted. Add planned locations to test geofencing!', 'info');
                }
                
            } catch (error) {
                console.error('Failed to test geofencing:', error);
                showNotification('Failed to test location tracking', 'error');
            }
        }

        function showEmergencyModal() {
            document.getElementById('emergency-modal').classList.remove('hidden');
        }

        async function handleEmergencyAlert(e) {
            e.preventDefault();
            
            if (!currentTrip) {
                showNotification('Please create a trip first', 'error');
                return;
            }

            const message = document.getElementById('emergency-message').value;
            
            try {
                await apiCall(`/safety/manual-alert?trip_id=${currentTrip.id}&message=${encodeURIComponent(message)}`, null, 'POST');
                showNotification('üö® Emergency alert sent! Emergency contacts will be notified.', 'success');
                closeModals();
                
            } catch (error) {
                console.error('Failed to send emergency alert:', error);
                showNotification(`Failed to send emergency alert: ${error.message}`, 'error');
            }
        }

        function setupModalHandlers() {
            // Close modal handlers
            document.querySelectorAll('.modal-close, .modal-cancel').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    closeModals();
                });
            });

            // Click outside to close modals
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModals();
                    }
                });
            });
        }

        function shareTrip(tripId) {
            const shareUrl = `${window.location.origin}/simple.html?shared_trip=${tripId}`;
            
            if (navigator.share) {
                // Use native sharing on mobile
                navigator.share({
                    title: 'rUok - Trip Share',
                    text: 'Follow my trip for safety monitoring',
                    url: shareUrl
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showNotification('üì§ Trip share link copied to clipboard!', 'success');
                }).catch(() => {
                    // Manual copy fallback
                    prompt('Copy this link to share your trip:', shareUrl);
                });
            }
        }

        // Location Search Functions
        function setupLocationSearch() {
            const searchInput = document.getElementById('location-search');
            const resultsContainer = document.getElementById('search-results');
            let searchTimeout;

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                if (query.length < 3) {
                    resultsContainer.classList.add('hidden');
                    return;
                }

                // Debounce search
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchLocations(query);
                }, 500);
            });

            // Hide results when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.form-group')) {
                    resultsContainer.classList.add('hidden');
                }
            });
        }

        async function searchLocations(query) {
            const resultsContainer = document.getElementById('search-results');
            
            try {
                // Using OpenStreetMap Nominatim API (free, no API key needed)
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`);
                const results = await response.json();

                if (results.length === 0) {
                    resultsContainer.innerHTML = '<div class="search-result-item">No locations found</div>';
                    resultsContainer.classList.remove('hidden');
                    return;
                }

                resultsContainer.innerHTML = results.map(result => `
                    <div class="search-result-item" onclick="selectLocation('${result.display_name}', ${result.lat}, ${result.lon})">
                        <div class="search-result-name">${result.display_name.split(',')[0]}</div>
                        <div class="search-result-address">${result.display_name}</div>
                    </div>
                `).join('');

                resultsContainer.classList.remove('hidden');

            } catch (error) {
                console.error('Location search failed:', error);
                resultsContainer.innerHTML = '<div class="search-result-item">Search failed. Please try again.</div>';
                resultsContainer.classList.remove('hidden');
            }
        }

        function selectLocation(name, lat, lng) {
            document.getElementById('location-name').value = name;
            document.getElementById('location-lat').value = parseFloat(lat).toFixed(6);
            document.getElementById('location-lng').value = parseFloat(lng).toFixed(6);
            document.getElementById('search-results').classList.add('hidden');
            
            showNotification(`üìç Location selected: ${name.split(',')[0]}`, 'success');
        }

        function quickSearch(query) {
            document.getElementById('location-search').value = query;
            searchLocations(query);
        }

        async function selectTripAndAddLocation(tripId) {
            try {
                const trip = await apiCall(`/trips/${tripId}`);
                currentTrip = trip;
                showNotification(`Selected trip: ${trip.name}`, 'info');
                showLocationModal();
            } catch (error) {
                console.error('Failed to select trip:', error);
                showNotification('Failed to select trip', 'error');
            }
        }

        function closeModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.add('hidden');
            });
            
            // Reset forms
            document.querySelectorAll('form').forEach(form => {
                if (form.id !== 'login-form' && form.id !== 'register-form') {
                    form.reset();
                }
            });

            // Hide search results
            document.getElementById('search-results').classList.add('hidden');
        }
    </script>
</body>
</html>